<!-- Updated Broker Offers Section -->
<div class="container my-5">
  <div class="row">
      <div class="col-12">
          <h2 class="mb-4 text-center">Broker Offers for Your Requests</h2>
          <div id="broker-offers-message-container"></div>
          
          <div class="table-responsive">
              <table id="broker-offers-table" class="table table-bordered table-striped">
                  <thead class="table-dark">
                      <tr>
                          <th>Request ID</th>
                          <th>Transaction Type</th>
                          <th>City</th>
                          <th>Area</th>
                          <th>Property Type</th>
                          <th>Bedrooms</th>
                          <th>Bathrooms</th>
                          <th>Your Budget</th>
                          <th>Request Date</th>
                          <th>Broker Response</th>
                          <th>Actions</th>
                      </tr>
                  </thead>
                  <tbody id="broker-offers-tbody">
                      <!-- Loaded via JavaScript -->
                  </tbody>
              </table>
              
              <div id="no-broker-offers-message" class="text-center py-5" style="display: none;">
                  <div class="alert alert-info">
                      <i class="fa fa-handshake"></i>
                      <h5>No Broker Offers Yet</h5>
                      <p>When brokers respond to your requests, their offers will appear here.</p>
                  </div>
              </div>
          </div>
      </div>
  </div>
</div>

<!-- Updated JavaScript for the table -->
<script>
// Updated loadBrokerOffers function
function loadBrokerOffers() {
  fetch('/api/inquiries/')
    .then(response => response.json())
    .then(data => {
      const tbody = document.getElementById('broker-offers-tbody');
      const noOffersMessage = document.getElementById('no-broker-offers-message');
      const table = document.getElementById('broker-offers-table');
      
      // Filter only inquiries that have broker responses
      const offersData = data.inquiries ? data.inquiries.filter(inquiry => inquiry.is_accepted && inquiry.broker_post) : [];
      
      if (offersData.length > 0) {
        tbody.innerHTML = '';
        table.style.display = 'table';
        noOffersMessage.style.display = 'none';
        
        offersData.forEach(inquiry => {
          const row = document.createElement('tr');
          
          // Format price range
          let priceRange = 'N/A';
          if (inquiry.min_price && inquiry.max_price) {
            priceRange = `${Number(inquiry.min_price).toLocaleString()} - ${Number(inquiry.max_price).toLocaleString()} EGP`;
          } else if (inquiry.min_price) {
            priceRange = `From ${Number(inquiry.min_price).toLocaleString()} EGP`;
          } else if (inquiry.max_price) {
            priceRange = `Up to ${Number(inquiry.max_price).toLocaleString()} EGP`;
          }
          
          // Format broker response with all details
          const brokerResponse = `
            <div class="small bg-light p-2 rounded">
              <div class="mb-1"><strong>Broker:</strong> ${inquiry.broker_post.broker_name}</div>
              <div class="mb-1"><strong>Commission:</strong> ${inquiry.broker_post.commission}%</div>
              <div class="mb-1"><strong>Accepted:</strong> ${new Date(inquiry.broker_post.accepted_at).toLocaleDateString()}</div>
              ${inquiry.broker_post.notes ? '<div><strong>Notes:</strong> ' + inquiry.broker_post.notes + '</div>' : ''}
            </div>
          `;
          
          row.innerHTML = `
            <td>${inquiry.id}</td>
            <td><span class="badge bg-${inquiry.transaction_type === 'rent' ? 'primary' : 'success'}">${inquiry.transaction_type}</span></td>
            <td>${inquiry.city || 'N/A'}</td>
            <td>${inquiry.area || 'N/A'}</td>
            <td>${inquiry.property_type || 'N/A'}</td>
            <td>${inquiry.bedrooms || 'N/A'}</td>
            <td>${inquiry.bathrooms || 'N/A'}</td>
            <td>${priceRange}</td>
            <td>${new Date(inquiry.created_at).toLocaleDateString()}</td>
            <td>${brokerResponse}</td>
            <td>
              <button class="btn btn-success btn-sm me-2 accept-offer-btn" data-inquiry-id="${inquiry.id}" data-broker-name="${inquiry.broker_post.broker_name}">
                <i class="fa fa-check"></i> Accept
              </button>
              <button class="btn btn-danger btn-sm reject-offer-btn" data-inquiry-id="${inquiry.id}" data-broker-name="${inquiry.broker_post.broker_name}">
                <i class="fa fa-times"></i> Reject
              </button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
        
        // Add event listeners for accept/reject buttons
        document.querySelectorAll('.accept-offer-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const inquiryId = this.getAttribute('data-inquiry-id');
            const brokerName = this.getAttribute('data-broker-name');
            showCustomerResponseModal(inquiryId, brokerName, 'accept');
          });
        });
        
        document.querySelectorAll('.reject-offer-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const inquiryId = this.getAttribute('data-inquiry-id');
            const brokerName = this.getAttribute('data-broker-name');
            showCustomerResponseModal(inquiryId, brokerName, 'reject');
          });
        });
        
      } else {
        table.style.display = 'none';
        noOffersMessage.style.display = 'block';
      }
    })
    .catch(error => {
      console.error('Error loading broker offers:', error);
      document.getElementById('broker-offers-message-container').innerHTML = 
        '<div class="alert alert-danger">Error loading broker offers. Please refresh the page.</div>';
    });
}
</script>
